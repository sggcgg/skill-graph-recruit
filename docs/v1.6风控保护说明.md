# v1.6 风控保护机制

> **版本**: v1.6  
> **更新时间**: 2026-01-24  
> **核心特性**: 自动检测风控，连续失败自动停止

---

## 🎯 新增特性

### 智能风控保护

**问题**: 如果连续多个关键词都没有数据，或者触发了验证码/登录过期，继续抓取会浪费时间，甚至加重风控。

**解决方案**: 
1. **实时风控检测** - 每次抓取后检测是否触发风控
2. **连续失败保护** - 连续失败N次自动停止
3. **进度保存** - 停止前保存进度，可随时继续

---

## 🛡️ 风控检测机制

### 1. 实时风控检测

在以下时机自动检测风控：
- ✅ 页面加载完成后
- ✅ 未捕获到数据包时

**检测内容**:

#### 验证码检测
```python
captcha_keywords = [
    '请完成安全验证',
    '安全验证',
    '滑动验证',
    '点击验证',
    'captcha',
    '验证码'
]
```

#### 登录过期检测
```python
login_keywords = [
    '请登录',
    '登录已过期',
    '需要登录',
    '请先登录'
]
```

#### 访问限制检测
```python
limit_keywords = [
    '访问过于频繁',
    '请稍后再试',
    '系统繁忙',
    '访问受限',
    '操作太频繁'
]
```

#### 异常跳转检测
- 跳转到错误页
- 跳转到首页
- URL异常

---

### 2. 连续失败保护

**机制**:
- 记录连续失败次数
- 达到上限自动停止
- 成功后重置计数

**配置**:
```python
self.max_consecutive_failures = 5  # 连续失败5次自动停止
self.consecutive_failures = 0      # 当前连续失败次数
```

**触发条件**:
1. 未捕获到数据包
2. 检测到风控（验证码、登录过期等）
3. 抓取过程异常

---

## 📊 工作流程

### 正常流程

```
任务1 → 成功 ✅ (失败计数: 0)
    ↓
任务2 → 成功 ✅ (失败计数: 0)
    ↓
任务3 → 成功 ✅ (失败计数: 0)
    ↓
继续...
```

### 偶尔失败流程

```
任务1 → 成功 ✅ (失败计数: 0)
    ↓
任务2 → 失败 ❌ (失败计数: 1)
    ↓
任务3 → 成功 ✅ (失败计数: 0) ← 重置
    ↓
继续...
```

### 连续失败流程（触发保护）

```
任务1 → 成功 ✅ (失败计数: 0)
    ↓
任务2 → 失败 ❌ (失败计数: 1) - 未捕获数据包
    ↓
任务3 → 失败 ❌ (失败计数: 2) - 未捕获数据包
    ↓
任务4 → 失败 ❌ (失败计数: 3) - 检测到验证码
    ↓
任务5 → 失败 ❌ (失败计数: 4) - 检测到验证码
    ↓
任务6 → 失败 ❌ (失败计数: 5) - 检测到验证码
    ↓
🛑 连续失败5次，自动停止！
    ↓
保存进度 → 关闭浏览器 → 退出程序
```

---

## 💡 使用示例

### 示例1：正常抓取（无风控）

```
🚀 开始任务: 北京 - Java
✅ 北京-Java 抓取完成！捕获数据包: 15 个

🚀 开始任务: 北京 - Python
✅ 北京-Python 抓取完成！捕获数据包: 12 个

🚀 开始任务: 北京 - Go
✅ 北京-Go 抓取完成！捕获数据包: 8 个

说明：一切正常，继续抓取
```

### 示例2：偶尔失败（自动恢复）

```
🚀 开始任务: 北京 - Java
✅ 北京-Java 抓取完成！捕获数据包: 15 个

🚀 开始任务: 北京 - Python
⚠️  未捕获到目标数据包
⚠️  任务失败 (1/5): 未捕获到数据包

🚀 开始任务: 北京 - Go
✅ 北京-Go 抓取完成！捕获数据包: 8 个
✓ 任务成功，重置失败计数（之前: 1）

说明：偶尔失败1次，后续成功，自动恢复
```

### 示例3：连续失败（触发保护）

```
🚀 开始任务: 北京 - Java
✅ 北京-Java 抓取完成！捕获数据包: 15 个

🚀 开始任务: 北京 - Python
⚠️  未捕获到目标数据包
⚠️  任务失败 (1/5): 未捕获到数据包

🚀 开始任务: 北京 - Go
⚠️  未捕获到目标数据包
⚠️  任务失败 (2/5): 未捕获到数据包

🚀 开始任务: 北京 - C++
⚠️  检测到风控: 触发验证码: 请完成安全验证
⚠️  任务失败 (3/5): 触发验证码: 请完成安全验证

🚀 开始任务: 北京 - Rust
⚠️  检测到风控: 触发验证码: 请完成安全验证
⚠️  任务失败 (4/5): 触发验证码: 请完成安全验证

🚀 开始任务: 北京 - Swift
⚠️  检测到风控: 触发验证码: 请完成安全验证
⚠️  任务失败 (5/5): 触发验证码: 请完成安全验证

======================================================================
🛑 连续失败 5 次，可能触发风控，自动停止抓取！
======================================================================

进度已保存，可稍后重新运行继续抓取
正在关闭浏览器...

说明：连续失败5次，自动停止，保护账号安全
```

---

## 🔧 配置调整

### 调整失败次数上限

如果觉得5次太敏感或太宽松，可以调整：

```python
# boss_listdata.py 第58行
self.max_consecutive_failures = 5  # 改为3（更敏感）或8（更宽松）
```

**建议值**:
- **3次**: 极度敏感，适合高风险账号
- **5次**: 推荐值，平衡安全和效率
- **8次**: 宽松模式，适合测试

### 关闭风控检测

如果不需要风控检测（不推荐）：

```python
# boss_listdata.py 第60行
self.enable_risk_detection = False  # 关闭风控检测
```

**注意**: 关闭后仍会检测连续失败，但不会检测验证码等风控信号。

---

## 📈 优势对比

### v1.5 vs v1.6

| 特性 | v1.5 | v1.6 |
|------|------|------|
| 智能检测底部 | ✅ | ✅ |
| 性能优化 | ✅ | ✅ |
| 风控检测 | ❌ | ✅ |
| 连续失败保护 | ❌ | ✅ |
| 自动停止 | ❌ | ✅ |
| 进度保存 | ✅ | ✅ |

### 保护效果

**v1.5（无保护）**:
```
触发验证码 → 继续抓取 → 浪费时间 → 可能加重风控 → 手动停止
```

**v1.6（有保护）**:
```
触发验证码 → 检测到风控 → 连续失败5次 → 自动停止 → 保存进度
```

---

## ⚠️ 注意事项

### 1. 进度保存

停止时会自动保存进度，包括：
- ✅ 已完成的城市
- ✅ 已完成的关键词
- ✅ 当前城市和关键词

**重新运行时**:
```bash
python src/crawler/boss_listdata.py

是否从上次中断的地方继续？(yes/no，输入'reset'重新开始): yes
```

### 2. 失败原因分析

**常见失败原因**:
1. **网络问题** - 临时网络波动
2. **数据量少** - 关键词本身数据就少（正常）
3. **验证码** - 触发风控，需要人工验证
4. **登录过期** - 需要重新扫码登录
5. **访问限制** - IP被限制，需要更换IP或等待

### 3. 应对策略

**偶尔失败（1-2次）**:
- ✅ 正常现象，继续运行
- ✅ 可能是网络波动或数据少

**连续失败（3-5次）**:
- ⚠️  可能触发风控
- ⚠️  建议停止，检查原因

**触发自动停止**:
- 🛑 确认触发风控
- 🛑 建议：
  1. 检查是否有验证码
  2. 检查登录是否过期
  3. 等待1-2小时后重试
  4. 或更换IP后重试

---

## 🎯 最佳实践

### 推荐配置

```python
# 风控保护配置
self.max_consecutive_failures = 5  # 连续失败5次停止
self.enable_risk_detection = True  # 启用风控检测

# 性能优化配置
self.fast_scroll_mode = True       # 快速滚动
self.scroll_times_per_keyword = 90 # 下滑90次

# 任务间隔配置
self.task_interval_min = 3         # 3-6秒任务间隔
self.task_interval_max = 6
self.long_break_interval = 15      # 每15个任务休息
```

### 执行建议

1. **首次运行**: 使用测试模式验证
2. **正式抓取**: 分6天完成，每天1个城市
3. **监控**: 观察失败次数，及时应对
4. **应对**: 触发停止后，等待1-2小时再继续

---

## 💯 总结

### v1.6核心优势

1. **智能保护** 🛡️
   - 实时检测风控
   - 自动停止抓取
   - 保护账号安全

2. **连续失败检测** 🔍
   - 记录失败次数
   - 达到上限停止
   - 成功后自动重置

3. **进度保存** 💾
   - 停止前保存进度
   - 随时可继续
   - 不丢失数据

4. **用户友好** 👍
   - 清晰的失败提示
   - 详细的原因说明
   - 明确的应对建议

### 版本演进

```
v1.3 原版（7小时/城市）
    ↓ 优化下滑速度
v1.4 性能优化（2小时/城市）- 提速3.3倍
    ↓ 智能检测底部
v1.5 智能检测（1.8小时/城市）- 再提速15%
    ↓ 风控保护
v1.6 风控保护（1.8小时/城市）- 安全性大幅提升 ⚡
```

### 下一步

1. ✅ 使用测试模式验证（2-3分钟）
2. ✅ 正式抓取1个城市（1.8-2小时）
3. ✅ 观察风控检测效果
4. ✅ 继续抓取其他城市

---

**版本**: v1.6  
**状态**: 已优化，推荐使用  
**特点**: 智能、快速、安全、可靠
